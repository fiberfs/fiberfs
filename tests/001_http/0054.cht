chttp_test "Request pipelining (server)"

# Server header pipeline

server_init
server_accept
server_pipeline_close
server_read_request
server_url_match /1
server_header_match raw true
server_send_response 200 OK body

chttp_init
chttp_raw_append "GET /1 HTTP/1.1\r\n"
chttp_raw_append "raw: true\r\n\r\n"
chttp_raw_append "GET"
chttp_connect $server_host $server_port
chttp_send
chttp_status_match 200
chttp_body_match body

# Server chunk pipeline

server_accept
server_pipeline_close
server_read_request
server_url_match /2
server_header_match body true
server_body_match reqbody
server_send_response 200 OK body2

chttp_reset
chttp_raw_append "GET /2 HTTP/1.1\r\n"
chttp_raw_append "body: true\r\n"
chttp_raw_append "Transfer-Encoding: chunked\r\n\r\n"
chttp_raw_append "7\r\nreqbody\r\n"
chttp_raw_append "0\r\n\r\n"
chttp_raw_append "GET"
chttp_new_connection
chttp_connect $server_host $server_port
chttp_send
chttp_status_match 200
chttp_body_match body2

# Server length pipeline

server_accept
server_pipeline_close
server_read_request
server_url_match /3
server_header_match body3 true
server_body_match lenbody
server_send_response 200 OK 3body3

chttp_reset
chttp_raw_append "GET /3 HTTP/1.1\r\n"
chttp_raw_append "body3: true\r\n"
chttp_raw_append "Content-Length: 7\r\n\r\n"
chttp_raw_append "lenbodyHTTP"
chttp_new_connection
chttp_connect $server_host $server_port
chttp_send
chttp_status_match 200
chttp_body_match 3body3
