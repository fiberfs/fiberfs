fiber_test "FS test with a page cache drop"

skip_shell_failure "sudo -n true 2> /dev/null"

# Init

sys_mkdir_tmp

fs_test_fuse_mount $sys_tmpdir

fs_test_fuse_init_root

# Do a bunch of operations

sys_ls $sys_tmpdir

set_var1 $sys_tmpdir "/fiber_dir02"
sys_ls $var1

set_var2 $var1 "/fiber_dir13"
sys_ls $var2

set_var3 $sys_tmpdir "/fiber_dir03/fiber_dir11/fiber_dir24/fiber_dir33"
sys_ls $var3 "..:dir .:dir fiber_41:file fiber_42:file fiber_43:file fiber_44:file fiber_dir41:dir fiber_dir42:dir fiber_dir43:dir fiber_dir44:dir"

set_var4 $sys_tmpdir "/fiber_dir03/fiber_dir11/"
sys_ls $var4

set_var5 $sys_tmpdir "/fiber_dir03/fiber_dir11/fiber_dir21/fiber_dir32/fiber_dir44"
sys_ls $var5 "..:dir .:dir fiber_51:file fiber_52:file fiber_53:file fiber_54:file"

# Expire cache

sleep_ms 1000

fs_test_release_root 0

fs_test_stats

# New operations

sys_ls $sys_tmpdir
sys_ls $var1
sys_ls $var2

# Cleanup

sleep_ms 100

fs_test_stats
fs_test_debug

shell "echo 2 | sudo -n tee /proc/sys/vm/drop_caches > /dev/null"
fs_test_release_root

fs_test_stats
fs_test_debug

equal $fs_test_stat_directories 0
equal $fs_test_stat_files 0
equal $fs_test_stat_file_refs 0

fuse_test_unmount
